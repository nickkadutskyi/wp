#!/bin/bash
#
# Sync uploads between two environments bidirectionally
# This is useful for keeping dev machines in sync or for two-way sync with staging
#
# Usage: bin/uploads-sync <source_env> <dest_env> [--dry-run]
#
# Examples:
#   bin/uploads-sync production local                  # Pull from production to local
#   bin/uploads-sync machine_name local                # Sync from machine_name to local
#   bin/uploads-sync local machine_name                # Sync from local to machine_name
#   bin/uploads-sync staging production --dry-run      # Preview staging -> production
#
# This script is a wrapper around uploads-pull and uploads-push for convenience
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Show usage
show_usage() {
  echo "Usage: bin/uploads-sync <source_env> <dest_env> [--dry-run]"
  echo ""
  echo "Arguments:"
  echo "  source_env    Source environment (production, staging, local, machine_name, etc.)"
  echo "  dest_env      Destination environment (production, staging, local, machine_name, etc.)"
  echo "  --dry-run     Optional: Show what would be transferred without making changes"
  echo ""
  echo "Examples:"
  echo "  bin/uploads-sync production local        # Pull from production to local"
  echo "  bin/uploads-sync machine_name local      # Pull from machine_name to local"
  echo "  bin/uploads-sync local staging           # Push from local to staging"
  echo "  bin/uploads-sync staging production      # Copy staging to production"
  echo ""
  echo "Note: When 'local' is involved, this uses uploads-pull or uploads-push."
  echo "      For syncing between two remote environments, files transfer through local."
}

# Parse arguments
DRY_RUN=""
ARGS=()
for arg in "$@"; do
  if [[ "$arg" == "--dry-run" ]]; then
    DRY_RUN="--dry-run"
  else
    ARGS+=("$arg")
  fi
done

# Check arguments
if [[ -z "${ARGS[0]}" ]]; then
  echo -e "${RED}Error: Source environment not specified${NC}"
  show_usage
  exit 1
fi

if [[ -z "${ARGS[1]}" ]]; then
  echo -e "${RED}Error: Destination environment not specified${NC}"
  show_usage
  exit 1
fi

SOURCE="${ARGS[0]}"
DEST="${ARGS[1]}"

# Determine which script to use
if [[ "$DEST" == "local" ]]; then
  # Pulling to local
  echo -e "${YELLOW}=== Syncing uploads: ${SOURCE} → local ===${NC}"
  echo ""
  "$SCRIPT_DIR/uploads-pull" "$SOURCE" $DRY_RUN
elif [[ "$SOURCE" == "local" ]]; then
  # Pushing from local
  echo -e "${YELLOW}=== Syncing uploads: local → ${DEST} ===${NC}"
  echo ""
  "$SCRIPT_DIR/uploads-push" "$DEST" $DRY_RUN
else
  # Both are remote - need to pull then push
  echo -e "${YELLOW}=== Syncing uploads: ${SOURCE} → ${DEST} (via local) ===${NC}"
  echo ""
  echo -e "${BLUE}This will:${NC}"
  echo "  1. Pull uploads from ${SOURCE} to local"
  echo "  2. Push uploads from local to ${DEST}"
  echo ""

  if [[ -z "$DRY_RUN" ]]; then
    read -r -p "Continue? [y/N] " response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
      echo "Aborted."
      exit 0
    fi
    echo ""
  fi

  echo -e "${GREEN}Step 1: Pulling from ${SOURCE}...${NC}"
  "$SCRIPT_DIR/uploads-pull" "$SOURCE" $DRY_RUN

  echo ""
  echo -e "${GREEN}Step 2: Pushing to ${DEST}...${NC}"
  "$SCRIPT_DIR/uploads-push" "$DEST" $DRY_RUN
fi

echo ""
echo -e "${GREEN}=== Sync Complete! ===${NC}"
