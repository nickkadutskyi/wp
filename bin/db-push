#!/bin/bash
#
# Push local database (or stdin) to a remote environment
#
# Usage: bin/db-push <environment> [ssh_host] [ssh_path]
#        cat backup.sql | bin/db-push <environment> [ssh_host] [ssh_path]
#
# Examples:
#   bin/db-push staging                                 # Push local DB to staging
#   bin/db-push production                              # Push local DB to production
#   bin/db-push macbook nick@macbook.local /path/to/wp # Custom SSH host and path
#   cat backup.sql | bin/db-push staging               # Restore backup.sql to staging
#
# Configuration:
#   Set these in your .env.local or .env.<environment>.local files:
#   - PRODUCTION_SSH_HOST (e.g., user@botaabdul.com)
#   - PRODUCTION_SSH_PATH (e.g., /var/www/botaabdul.com)
#   - STAGING_SSH_HOST (e.g., user@staging.botaabdul.com)
#   - STAGING_SSH_PATH (e.g., /var/www/staging.botaabdul.com)
#
# WARNING: This is a destructive operation on the remote database!
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Check if we have stdin (piped input)
HAS_STDIN=false
if [[ ! -t 0 ]]; then
  HAS_STDIN=true
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Find wp-cli locally (only needed if not using stdin)
find_local_wp() {
  if command -v wp >/dev/null; then
    echo "$(command -v wp)"
  elif [[ -x "$PROJECT_ROOT/vendor/bin/wp" ]]; then
    echo "$PROJECT_ROOT/vendor/bin/wp"
  elif [[ -f "$PROJECT_ROOT/wp-cli.phar" ]]; then
    [[ ! -x "$PROJECT_ROOT/wp-cli.phar" ]] && chmod +x "$PROJECT_ROOT/wp-cli.phar"
    echo "$PROJECT_ROOT/wp-cli.phar"
  else
    echo ""
  fi
}

# Remote WP-CLI wrapper script (inline version for passing as argument)
# This gets executed on the remote machine to find and run wp-cli
# It handles: direnv/nix environments, vendor/bin/wp, and wp-cli.phar
REMOTE_WP_INLINE='
cd "$1" && shift
if [[ -f .envrc ]] && command -v direnv >/dev/null 2>&1; then
  eval "$(direnv export bash 2>/dev/null)" || true
fi
if command -v wp >/dev/null 2>&1; then
  wp "$@"
elif [[ -x vendor/bin/wp ]]; then
  vendor/bin/wp "$@"
elif [[ -f wp-cli.phar ]]; then
  php wp-cli.phar "$@"
else
  echo "Error: wp-cli not found on remote" >&2
  exit 1
fi
'

# Function to run wp-cli on remote
remote_wp() {
  local path="$1"
  shift
  ssh "$SSH_HOST" "bash -c $(printf '%q' "$REMOTE_WP_INLINE")" -- "$path" "$@"
}

# Load environment variables
load_env() {
  local env_file="$1"
  if [[ -f "$env_file" ]]; then
    set -a
    # shellcheck source=/dev/null
    source "$env_file"
    set +a
  fi
}

# Load env files in order (later files override earlier)
load_env "$PROJECT_ROOT/.env"
load_env "$PROJECT_ROOT/.env.local"
load_env "$PROJECT_ROOT/.env.development"
load_env "$PROJECT_ROOT/.env.development.local"

# Show usage
show_usage() {
  echo "Usage: bin/db-push <environment> [ssh_host] [ssh_path]"
  echo "       cat backup.sql | bin/db-push <environment>"
  echo ""
  echo "Arguments:"
  echo "  environment   Environment name (production, staging, or custom label)"
  echo "  ssh_host      Optional: SSH host (e.g., user@hostname)"
  echo "  ssh_path      Optional: Remote project path"
  echo ""
  echo "Examples:"
  echo "  bin/db-push staging"
  echo "  bin/db-push production"
  echo "  bin/db-push macbook nick@macbook.local /Users/nick/Sites/project"
  echo "  cat backup.sql | bin/db-push staging"
}

# Check arguments
if [[ -z "$1" ]]; then
  echo -e "${RED}Error: Environment not specified${NC}"
  show_usage
  exit 1
fi

ENV="$1"
ENV_UPPER=$(echo "$ENV" | tr '[:lower:]' '[:upper:]')

# Get SSH configuration - command line args override env vars
SSH_HOST_VAR="${ENV_UPPER}_SSH_HOST"
SSH_PATH_VAR="${ENV_UPPER}_SSH_PATH"

# Use command line arguments if provided, otherwise fall back to env vars
if [[ -n "$2" ]]; then
  SSH_HOST="$2"
else
  SSH_HOST="${!SSH_HOST_VAR}"
fi

if [[ -n "$3" ]]; then
  SSH_PATH="$3"
else
  SSH_PATH="${!SSH_PATH_VAR}"
fi

# Validate SSH configuration
if [[ -z "$SSH_HOST" ]]; then
  echo -e "${RED}Error: SSH host not specified${NC}"
  echo "Either provide it as an argument or set ${SSH_HOST_VAR} in .env.local"
  echo ""
  show_usage
  exit 1
fi

if [[ -z "$SSH_PATH" ]]; then
  echo -e "${RED}Error: SSH path not specified${NC}"
  echo "Either provide it as an argument or set ${SSH_PATH_VAR} in .env.local"
  echo ""
  show_usage
  exit 1
fi

# Create backups directory
BACKUP_DIR="$PROJECT_ROOT/.db-backups"
mkdir -p "$BACKUP_DIR"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")

# Different flow depending on whether we have stdin
if [[ "$HAS_STDIN" == "true" ]]; then
  # ============================================
  # RESTORE MODE: Import SQL from stdin
  # ============================================

  # Save stdin to a temp file so we can use it after prompts
  STDIN_FILE="$BACKUP_DIR/.stdin_${TIMESTAMP}.sql"
  cat > "$STDIN_FILE"

  echo -e "${RED}!!! WARNING !!!${NC}"
  echo -e "${YELLOW}=== Database Restore to ${ENV} ===${NC}"
  echo "Remote: ${SSH_HOST}:${SSH_PATH}"
  echo "Source: stdin ($(du -h "$STDIN_FILE" | cut -f1))"
  echo ""
  echo -e "${RED}This will REPLACE the ${ENV} database with the provided SQL!${NC}"
  echo -e "${YELLOW}Note: No URL search-replace will be performed.${NC}"
  echo ""

  # Extra confirmation for production (read from terminal, not stdin)
  if [[ "$ENV" == "production" ]]; then
    echo -e "${RED}You are restoring to PRODUCTION!${NC}"
    read -r -p "Type 'yes-restore-to-production' to confirm: " response < /dev/tty
    if [[ "$response" != "yes-restore-to-production" ]]; then
      rm -f "$STDIN_FILE"
      echo "Aborted."
      exit 0
    fi
  else
    read -r -p "Are you sure you want to continue? [y/N] " response < /dev/tty
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
      rm -f "$STDIN_FILE"
      echo "Aborted."
      exit 0
    fi
  fi

  # Step 1: Backup remote database
  echo -e "\n${GREEN}[1/2] Backing up remote database...${NC}"
  REMOTE_BACKUP="$BACKUP_DIR/${ENV}_backup_${TIMESTAMP}.sql"
  remote_wp "$SSH_PATH" db export - > "$REMOTE_BACKUP"
  echo "  Saved to: $REMOTE_BACKUP"

  # Step 2: Import from stdin file
  echo -e "\n${GREEN}[2/2] Importing database...${NC}"
  cat "$STDIN_FILE" | remote_wp "$SSH_PATH" db import -
  rm -f "$STDIN_FILE"
  echo "  Done!"

  # Flush remote caches
  echo -e "\n${GREEN}Flushing remote caches...${NC}"
  remote_wp "$SSH_PATH" rewrite flush --quiet 2>/dev/null || true
  remote_wp "$SSH_PATH" cache flush --quiet 2>/dev/null || true

  echo -e "\n${GREEN}=== Complete! ===${NC}"
  echo "Remote backup: $REMOTE_BACKUP"

else
  # ============================================
  # PUSH MODE: Export local DB and push to remote
  # ============================================

  # Find local wp-cli
  WP=$(find_local_wp)
  if [[ -z "$WP" ]]; then
    echo -e "${RED}Error: wp-cli not found locally${NC}" >&2
    exit 1
  fi

  # Get local site URL
  LOCAL_URL="${WP_HOME:-https://botaabdul.test}"
  LOCAL_EXPORT="$BACKUP_DIR/local_export_${TIMESTAMP}.sql"

  echo -e "${RED}!!! WARNING !!!${NC}"
  echo -e "${YELLOW}=== Database Push to ${ENV} ===${NC}"
  echo "Remote: ${SSH_HOST}:${SSH_PATH}"
  echo "Local URL: ${LOCAL_URL}"
  echo ""
  echo -e "${RED}This will REPLACE the ${ENV} database with your local database!${NC}"
  echo ""

  # Extra confirmation for production
  if [[ "$ENV" == "production" ]]; then
    echo -e "${RED}You are pushing to PRODUCTION!${NC}"
    read -r -p "Type 'yes-push-to-production' to confirm: " response
    if [[ "$response" != "yes-push-to-production" ]]; then
      echo "Aborted."
      exit 0
    fi
  else
    read -r -p "Are you sure you want to continue? [y/N] " response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
      echo "Aborted."
      exit 0
    fi
  fi

  # Step 1: Get remote site URL
  echo -e "\n${GREEN}[1/4] Getting remote site URL...${NC}"
  REMOTE_URL=$(remote_wp "$SSH_PATH" option get home)
  echo "  Remote URL: $REMOTE_URL"

  # Step 2: Backup remote database
  echo -e "\n${GREEN}[2/4] Backing up remote database...${NC}"
  REMOTE_BACKUP="$BACKUP_DIR/${ENV}_backup_${TIMESTAMP}.sql"
  remote_wp "$SSH_PATH" db export - > "$REMOTE_BACKUP"
  echo "  Saved to: $REMOTE_BACKUP"

  # Step 3: Export local database
  echo -e "\n${GREEN}[3/4] Exporting local database...${NC}"
  cd "$PROJECT_ROOT"
  $WP db export "$LOCAL_EXPORT" --quiet
  echo "  Exported to: $LOCAL_EXPORT"

  # Step 4: Import to remote and search-replace
  echo -e "\n${GREEN}[4/4] Importing to remote and replacing URLs...${NC}"
  cat "$LOCAL_EXPORT" | remote_wp "$SSH_PATH" db import -
  remote_wp "$SSH_PATH" search-replace "$LOCAL_URL" "$REMOTE_URL" --all-tables --quiet --precise
  echo "  Done!"

  # Flush remote caches
  echo -e "\n${GREEN}Flushing remote caches...${NC}"
  remote_wp "$SSH_PATH" rewrite flush --quiet 2>/dev/null || true
  remote_wp "$SSH_PATH" cache flush --quiet 2>/dev/null || true

  echo -e "\n${GREEN}=== Complete! ===${NC}"
  echo "Remote backup: $REMOTE_BACKUP"
  echo ""
  echo "To restore the remote backup:"
  echo "  cat $REMOTE_BACKUP | bin/db-push $ENV"
fi

