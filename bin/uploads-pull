#!/bin/bash
#
# Pull uploads directory from a remote environment to local
#
# Usage: bin/uploads-pull <environment> [ssh_host] [ssh_path] [--dry-run]
#
# Examples:
#   bin/uploads-pull production                              # Pull from production
#   bin/uploads-pull staging                                 # Pull from staging
#   bin/uploads-pull machine_name                            # Pull from another dev machine
#   bin/uploads-pull production --dry-run                    # Preview what would be synced
#   bin/uploads-pull custom user@mypc.local /path/to/wp     # Custom SSH host and path
#
# Configuration:
#   Set these in your .env.local or .env.<environment>.local files:
#   - PRODUCTION_SSH_HOST (e.g., bitnami@example.com)
#   - PRODUCTION_SSH_PATH (e.g., /opt/bitnami/marketing-site)
#   - STAGING_SSH_HOST (e.g., bitnami@example.com)
#   - STAGING_SSH_PATH (e.g., /opt/bitnami/marketing-site-staging)
#   - MACHINE_NAME_SSH_HOST (e.g., nick@machinename.com)
#   - MACHINE_NAME_SSH_PATH (e.g., ~/Documents/project_site)
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Uploads directory relative to project root
UPLOADS_DIR="public/content/uploads"

# Load environment variables
load_env() {
  local env_file="$1"
  if [[ -f "$env_file" ]]; then
    # Export variables, ignoring comments and empty lines
    set -a
    # shellcheck source=/dev/null
    source "$env_file"
    set +a
  fi
}

# Load env files in order (later files override earlier)
load_env "$PROJECT_ROOT/.env"
load_env "$PROJECT_ROOT/.env.local"
load_env "$PROJECT_ROOT/.env.development"
load_env "$PROJECT_ROOT/.env.development.local"

# Show usage
show_usage() {
  echo "Usage: bin/uploads-pull <environment> [ssh_host] [ssh_path] [--dry-run]"
  echo ""
  echo "Arguments:"
  echo "  environment   Environment name (production, staging, machine_name, etc.)"
  echo "  ssh_host      Optional: SSH host (e.g., user@hostname)"
  echo "  ssh_path      Optional: Remote project path"
  echo "  --dry-run     Optional: Show what would be transferred without making changes"
  echo ""
  echo "Examples:"
  echo "  bin/uploads-pull production"
  echo "  bin/uploads-pull staging --dry-run"
  echo "  bin/uploads-pull machine_name"
  echo "  bin/uploads-pull custom user@macbook.local /Users/nick/Sites/project"
}

# Parse arguments
DRY_RUN=""
ARGS=()
for arg in "$@"; do
  if [[ "$arg" == "--dry-run" ]]; then
    DRY_RUN="--dry-run"
  else
    ARGS+=("$arg")
  fi
done

# Check arguments
if [[ -z "${ARGS[0]}" ]]; then
  echo -e "${RED}Error: Environment not specified${NC}"
  show_usage
  exit 1
fi

ENV="${ARGS[0]}"
ENV_UPPER=$(echo "$ENV" | tr '[:lower:]' '[:upper:]')

# Get SSH configuration - command line args override env vars
SSH_HOST_VAR="${ENV_UPPER}_SSH_HOST"
SSH_PATH_VAR="${ENV_UPPER}_SSH_PATH"

# Use command line arguments if provided, otherwise fall back to env vars
if [[ -n "${ARGS[1]}" ]]; then
  SSH_HOST="${ARGS[1]}"
else
  SSH_HOST="${!SSH_HOST_VAR}"
fi

if [[ -n "${ARGS[2]}" ]]; then
  SSH_PATH="${ARGS[2]}"
else
  SSH_PATH="${!SSH_PATH_VAR}"
fi

# Validate SSH configuration
if [[ -z "$SSH_HOST" ]]; then
  echo -e "${RED}Error: SSH host not specified${NC}"
  echo "Either provide it as an argument or set ${SSH_HOST_VAR} in .env.local"
  echo ""
  show_usage
  exit 1
fi

if [[ -z "$SSH_PATH" ]]; then
  echo -e "${RED}Error: SSH path not specified${NC}"
  echo "Either provide it as an argument or set ${SSH_PATH_VAR} in .env.local"
  echo ""
  show_usage
  exit 1
fi

# Ensure uploads directory exists locally
mkdir -p "$PROJECT_ROOT/$UPLOADS_DIR"

# Remote uploads path
REMOTE_UPLOADS="${SSH_HOST}:${SSH_PATH}/${UPLOADS_DIR}/"
LOCAL_UPLOADS="$PROJECT_ROOT/$UPLOADS_DIR/"

if [[ -n "$DRY_RUN" ]]; then
  echo -e "${BLUE}=== Uploads Pull (DRY RUN) from ${ENV} ===${NC}"
else
  echo -e "${YELLOW}=== Uploads Pull from ${ENV} ===${NC}"
fi

echo "Remote: ${REMOTE_UPLOADS}"
echo "Local:  ${LOCAL_UPLOADS}"
echo ""

# Get size of remote uploads directory
echo -e "${GREEN}Checking remote uploads size...${NC}"
REMOTE_SIZE=$(ssh "$SSH_HOST" "du -sh '${SSH_PATH}/${UPLOADS_DIR}' 2>/dev/null | cut -f1" || echo "unknown")
echo "  Remote size: ${REMOTE_SIZE}"

# Get size of local uploads directory
LOCAL_SIZE=$(du -sh "$LOCAL_UPLOADS" 2>/dev/null | cut -f1 || echo "0B")
echo "  Local size:  ${LOCAL_SIZE}"
echo ""

if [[ -z "$DRY_RUN" ]]; then
  # Confirm action
  read -r -p "This will sync remote uploads to your LOCAL directory. Continue? [y/N] " response
  if [[ ! "$response" =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 0
  fi
  echo ""
fi

# Rsync options:
# -a, --archive        archive mode (preserves permissions, times, etc.)
# -v, --verbose        increase verbosity
# -z, --compress       compress file data during transfer
# -h, --human-readable output numbers in human-readable format
# --progress           show progress during transfer
# --delete             delete extraneous files from destination
# --exclude            exclude files matching pattern
RSYNC_OPTS=(
  -avzh
  --progress
  --delete
  --exclude='.gitignore'
  --exclude='index.php'
  --exclude='.DS_Store'
  --exclude='Thumbs.db'
)

if [[ -n "$DRY_RUN" ]]; then
  RSYNC_OPTS+=("$DRY_RUN")
  echo -e "${BLUE}Performing dry run (no files will be changed)...${NC}"
else
  echo -e "${GREEN}Syncing uploads...${NC}"
fi

# Execute rsync
rsync "${RSYNC_OPTS[@]}" "$REMOTE_UPLOADS" "$LOCAL_UPLOADS"

if [[ -n "$DRY_RUN" ]]; then
  echo ""
  echo -e "${BLUE}=== Dry Run Complete ===${NC}"
  echo "No files were changed. Run without --dry-run to perform the actual sync."
else
  echo ""
  echo -e "${GREEN}=== Complete! ===${NC}"
  echo "Uploads synced from ${ENV} to local"

  # Show new local size
  NEW_LOCAL_SIZE=$(du -sh "$LOCAL_UPLOADS" 2>/dev/null | cut -f1)
  echo "New local size: ${NEW_LOCAL_SIZE}"
fi
