#!/bin/bash
#
# Push local uploads directory to a remote environment
#
# Usage: bin/uploads-push <environment> [ssh_host] [ssh_path] [--dry-run]
#
# Examples:
#   bin/uploads-push staging                                 # Push to staging
#   bin/uploads-push production                              # Push to production
#   bin/uploads-push machine_name                            # Push to another dev machine
#   bin/uploads-push staging --dry-run                       # Preview what would be synced
#   bin/uploads-push custom user@mypc.local /path/to/wp     # Custom SSH host and path
#
# Configuration:
#   Set these in your .env.local or .env.<environment>.local files:
#   - PRODUCTION_SSH_HOST (e.g., bitnami@example.com)
#   - PRODUCTION_SSH_PATH (e.g., /opt/bitnami/marketing-site)
#   - STAGING_SSH_HOST (e.g., bitnami@example.com)
#   - STAGING_SSH_PATH (e.g., /opt/bitnami/marketing-site-staging)
#   - MACHINE_NAME_SSH_HOST (e.g., nick@machinename.com)
#   - MACHINE_NAME_SSH_PATH (e.g., ~/Documents/project_site)
#
# WARNING: This is a destructive operation on the remote uploads directory!
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Uploads directory relative to project root
UPLOADS_DIR="public/content/uploads"

# Load environment variables
load_env() {
  local env_file="$1"
  if [[ -f "$env_file" ]]; then
    # Export variables, ignoring comments and empty lines
    set -a
    # shellcheck source=/dev/null
    source "$env_file"
    set +a
  fi
}

# Load env files in order (later files override earlier)
load_env "$PROJECT_ROOT/.env"
load_env "$PROJECT_ROOT/.env.local"
load_env "$PROJECT_ROOT/.env.development"
load_env "$PROJECT_ROOT/.env.development.local"

# Show usage
show_usage() {
  echo "Usage: bin/uploads-push <environment> [ssh_host] [ssh_path] [--dry-run]"
  echo ""
  echo "Arguments:"
  echo "  environment   Environment name (production, staging, machine_name, etc.)"
  echo "  ssh_host      Optional: SSH host (e.g., user@hostname)"
  echo "  ssh_path      Optional: Remote project path"
  echo "  --dry-run     Optional: Show what would be transferred without making changes"
  echo ""
  echo "Examples:"
  echo "  bin/uploads-push staging"
  echo "  bin/uploads-push production --dry-run"
  echo "  bin/uploads-push machine_name"
  echo "  bin/uploads-push custom user@macbook.local /Users/nick/Sites/project"
}

# Parse arguments
DRY_RUN=""
ARGS=()
for arg in "$@"; do
  if [[ "$arg" == "--dry-run" ]]; then
    DRY_RUN="--dry-run"
  else
    ARGS+=("$arg")
  fi
done

# Check arguments
if [[ -z "${ARGS[0]}" ]]; then
  echo -e "${RED}Error: Environment not specified${NC}"
  show_usage
  exit 1
fi

ENV="${ARGS[0]}"
ENV_UPPER=$(echo "$ENV" | tr '[:lower:]' '[:upper:]')

# Get SSH configuration - command line args override env vars
SSH_HOST_VAR="${ENV_UPPER}_SSH_HOST"
SSH_PATH_VAR="${ENV_UPPER}_SSH_PATH"

# Use command line arguments if provided, otherwise fall back to env vars
if [[ -n "${ARGS[1]}" ]]; then
  SSH_HOST="${ARGS[1]}"
else
  SSH_HOST="${!SSH_HOST_VAR}"
fi

if [[ -n "${ARGS[2]}" ]]; then
  SSH_PATH="${ARGS[2]}"
else
  SSH_PATH="${!SSH_PATH_VAR}"
fi

# Validate SSH configuration
if [[ -z "$SSH_HOST" ]]; then
  echo -e "${RED}Error: SSH host not specified${NC}"
  echo "Either provide it as an argument or set ${SSH_HOST_VAR} in .env.local"
  echo ""
  show_usage
  exit 1
fi

if [[ -z "$SSH_PATH" ]]; then
  echo -e "${RED}Error: SSH path not specified${NC}"
  echo "Either provide it as an argument or set ${SSH_PATH_VAR} in .env.local"
  echo ""
  show_usage
  exit 1
fi

# Validate local uploads directory exists
LOCAL_UPLOADS="$PROJECT_ROOT/$UPLOADS_DIR/"
if [[ ! -d "$LOCAL_UPLOADS" ]]; then
  echo -e "${RED}Error: Local uploads directory not found: ${LOCAL_UPLOADS}${NC}"
  exit 1
fi

# Remote uploads path
REMOTE_UPLOADS="${SSH_HOST}:${SSH_PATH}/${UPLOADS_DIR}/"

if [[ -n "$DRY_RUN" ]]; then
  echo -e "${BLUE}=== Uploads Push (DRY RUN) to ${ENV} ===${NC}"
else
  echo -e "${RED}!!! WARNING !!!${NC}"
  echo -e "${YELLOW}=== Uploads Push to ${ENV} ===${NC}"
fi

echo "Local:  ${LOCAL_UPLOADS}"
echo "Remote: ${REMOTE_UPLOADS}"
echo ""

# Get size of local uploads directory
LOCAL_SIZE=$(du -sh "$LOCAL_UPLOADS" 2>/dev/null | cut -f1 || echo "0B")
echo "  Local size:  ${LOCAL_SIZE}"

# Get size of remote uploads directory
echo -e "${GREEN}Checking remote uploads size...${NC}"
REMOTE_SIZE=$(ssh "$SSH_HOST" "du -sh '${SSH_PATH}/${UPLOADS_DIR}' 2>/dev/null | cut -f1" || echo "unknown")
echo "  Remote size: ${REMOTE_SIZE}"
echo ""

if [[ -z "$DRY_RUN" ]]; then
  echo -e "${RED}This will sync your LOCAL uploads to the ${ENV} environment!${NC}"
  echo -e "${YELLOW}Files on ${ENV} that don't exist locally will be DELETED!${NC}"
  echo ""

  # Extra confirmation for production
  if [[ "$ENV" == "production" ]]; then
    echo -e "${RED}You are pushing to PRODUCTION!${NC}"
    read -r -p "Type 'yes-push-to-production' to confirm: " response
    if [[ "$response" != "yes-push-to-production" ]]; then
      echo "Aborted."
      exit 0
    fi
  else
    read -r -p "Are you sure you want to continue? [y/N] " response
    if [[ ! "$response" =~ ^[Yy]$ ]]; then
      echo "Aborted."
      exit 0
    fi
  fi
  echo ""
fi

# Ensure remote uploads directory exists
echo -e "${GREEN}Ensuring remote uploads directory exists...${NC}"
ssh "$SSH_HOST" "mkdir -p '${SSH_PATH}/${UPLOADS_DIR}'"

# Rsync options:
# -a, --archive        archive mode (preserves permissions, times, etc.)
# -v, --verbose        increase verbosity
# -z, --compress       compress file data during transfer
# -h, --human-readable output numbers in human-readable format
# --progress           show progress during transfer
# --delete             delete extraneous files from destination
# --exclude            exclude files matching pattern
RSYNC_OPTS=(
  -avzh
  --progress
  --delete
  --exclude='.gitignore'
  --exclude='index.php'
  --exclude='.DS_Store'
  --exclude='Thumbs.db'
)

if [[ -n "$DRY_RUN" ]]; then
  RSYNC_OPTS+=("$DRY_RUN")
  echo -e "${BLUE}Performing dry run (no files will be changed)...${NC}"
else
  echo -e "${GREEN}Syncing uploads...${NC}"
fi

# Execute rsync
rsync "${RSYNC_OPTS[@]}" "$LOCAL_UPLOADS" "$REMOTE_UPLOADS"

if [[ -n "$DRY_RUN" ]]; then
  echo ""
  echo -e "${BLUE}=== Dry Run Complete ===${NC}"
  echo "No files were changed. Run without --dry-run to perform the actual sync."
else
  echo ""
  echo -e "${GREEN}=== Complete! ===${NC}"
  echo "Uploads synced from local to ${ENV}"

  # Show new remote size
  NEW_REMOTE_SIZE=$(ssh "$SSH_HOST" "du -sh '${SSH_PATH}/${UPLOADS_DIR}' 2>/dev/null | cut -f1" || echo "unknown")
  echo "New remote size: ${NEW_REMOTE_SIZE}"
fi
