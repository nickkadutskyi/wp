#!/bin/bash
#
# Pull database from a remote environment (production/staging) or custom host to local
#
# Usage: bin/db-pull <environment> [ssh_host] [ssh_path]
#
# Examples:
#   bin/db-pull production                              # Use configured production
#   bin/db-pull staging                                 # Use configured staging
#   bin/db-pull custom user@mypc.local /path/to/wp     # Custom SSH host and path
#   bin/db-pull production user@alt-server.com         # Override host only
#
# Configuration:
#   Set these in your .env.local or .env.<environment>.local files:
#   - PRODUCTION_SSH_HOST (e.g., user@example.com)
#   - PRODUCTION_SSH_PATH (e.g., /var/www/example.com)
#   - STAGING_SSH_HOST (e.g., user@staging.example.com)
#   - STAGING_SSH_PATH (e.g., /var/www/staging.example.com)
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Find wp-cli locally
WP=
if command -v wp >/dev/null; then
  WP=$(command -v wp)
elif [[ -x "$PROJECT_ROOT/vendor/bin/wp" ]]; then
  WP="$PROJECT_ROOT/vendor/bin/wp"
elif [[ -f "$PROJECT_ROOT/wp-cli.phar" ]]; then
  [[ ! -x "$PROJECT_ROOT/wp-cli.phar" ]] && chmod +x "$PROJECT_ROOT/wp-cli.phar"
  WP="$PROJECT_ROOT/wp-cli.phar"
else
  echo -e "${RED}Error: wp-cli not found${NC}" >&2
  exit 1
fi

# Remote WP-CLI wrapper script (inline version for passing as argument)
# This gets executed on the remote machine to find and run wp-cli
# It handles: direnv/nix environments, vendor/bin/wp, and wp-cli.phar
REMOTE_WP_INLINE='
cd "$1" && shift
if [[ -f .envrc ]] && command -v direnv >/dev/null 2>&1; then
  eval "$(direnv export bash 2>/dev/null)" || true
fi
if command -v wp >/dev/null 2>&1; then
  wp "$@"
elif [[ -x vendor/bin/wp ]]; then
  vendor/bin/wp "$@"
elif [[ -f wp-cli.phar ]]; then
  php wp-cli.phar "$@"
else
  echo "Error: wp-cli not found on remote" >&2
  exit 1
fi
'

# Function to run wp-cli on remote
remote_wp() {
  local path="$1"
  shift
  ssh "$SSH_HOST" "bash -c $(printf '%q' "$REMOTE_WP_INLINE")" -- "$path" "$@"
}

# Load environment variables
load_env() {
  local env_file="$1"
  if [[ -f "$env_file" ]]; then
    # Export variables, ignoring comments and empty lines
    set -a
    # shellcheck source=/dev/null
    source "$env_file"
    set +a
  fi
}

# Load env files in order (later files override earlier)
load_env "$PROJECT_ROOT/.env"
load_env "$PROJECT_ROOT/.env.local"
load_env "$PROJECT_ROOT/.env.development"
load_env "$PROJECT_ROOT/.env.development.local"

# Show usage
show_usage() {
  echo "Usage: bin/db-pull <environment> [ssh_host] [ssh_path]"
  echo ""
  echo "Arguments:"
  echo "  environment   Environment name (production, staging, or custom label)"
  echo "  ssh_host      Optional: SSH host (e.g., user@hostname)"
  echo "  ssh_path      Optional: Remote project path"
  echo ""
  echo "Examples:"
  echo "  bin/db-pull production"
  echo "  bin/db-pull staging"
  echo "  bin/db-pull macbook nick@macbook.local /Users/nick/Sites/project"
  echo "  bin/db-pull production user@alt-server.com /var/www/html"
}

# Check arguments
if [[ -z "$1" ]]; then
  echo -e "${RED}Error: Environment not specified${NC}"
  show_usage
  exit 1
fi

ENV="$1"
ENV_UPPER=$(echo "$ENV" | tr '[:lower:]' '[:upper:]')

# Get SSH configuration - command line args override env vars
SSH_HOST_VAR="${ENV_UPPER}_SSH_HOST"
SSH_PATH_VAR="${ENV_UPPER}_SSH_PATH"

# Use command line arguments if provided, otherwise fall back to env vars
if [[ -n "$2" ]]; then
  SSH_HOST="$2"
else
  SSH_HOST="${!SSH_HOST_VAR}"
fi

if [[ -n "$3" ]]; then
  SSH_PATH="$3"
else
  SSH_PATH="${!SSH_PATH_VAR}"
fi

# Validate SSH configuration
if [[ -z "$SSH_HOST" ]]; then
  echo -e "${RED}Error: SSH host not specified${NC}"
  echo "Either provide it as an argument or set ${SSH_HOST_VAR} in .env.local"
  echo ""
  show_usage
  exit 1
fi

if [[ -z "$SSH_PATH" ]]; then
  echo -e "${RED}Error: SSH path not specified${NC}"
  echo "Either provide it as an argument or set ${SSH_PATH_VAR} in .env.local"
  echo ""
  show_usage
  exit 1
fi

# Get local site URL
LOCAL_URL="${WP_HOME:-https://localhost}"

# Create backups directory
BACKUP_DIR="$PROJECT_ROOT/.db-backups"
mkdir -p "$BACKUP_DIR"

TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
LOCAL_BACKUP="$BACKUP_DIR/local_${TIMESTAMP}.sql"
REMOTE_BACKUP="$BACKUP_DIR/${ENV}_${TIMESTAMP}.sql"

echo -e "${YELLOW}=== Database Pull from ${ENV} ===${NC}"
echo "Remote: ${SSH_HOST}:${SSH_PATH}"
echo "Local URL: ${LOCAL_URL}"
echo ""

# Confirm action
read -r -p "This will replace your LOCAL database. Continue? [y/N] " response
if [[ ! "$response" =~ ^[Yy]$ ]]; then
  echo "Aborted."
  exit 0
fi

# Step 1: Backup local database
echo -e "\n${GREEN}[1/4] Backing up local database...${NC}"
cd "$PROJECT_ROOT"
$WP db export "$LOCAL_BACKUP" --quiet
echo "  Saved to: $LOCAL_BACKUP"

# Step 2: Get remote site URL
echo -e "\n${GREEN}[2/4] Getting remote site URL...${NC}"
REMOTE_URL=$(remote_wp "$SSH_PATH" option get home)
echo "  Remote URL: $REMOTE_URL"

# Step 3: Export remote database
echo -e "\n${GREEN}[3/4] Exporting remote database...${NC}"
remote_wp "$SSH_PATH" db export - > "$REMOTE_BACKUP"
echo "  Saved to: $REMOTE_BACKUP"

# Step 4: Import and search-replace
echo -e "\n${GREEN}[4/4] Importing database and replacing URLs...${NC}"
$WP db import "$REMOTE_BACKUP" --quiet
$WP search-replace "$REMOTE_URL" "$LOCAL_URL" --all-tables --quiet
echo "  Done!"

# Flush rewrite rules and cache
echo -e "\n${GREEN}Flushing caches...${NC}"
$WP rewrite flush --quiet 2>/dev/null || true
$WP cache flush --quiet 2>/dev/null || true

echo -e "\n${GREEN}=== Complete! ===${NC}"
echo "Local backup: $LOCAL_BACKUP"
echo "Remote backup: $REMOTE_BACKUP"
echo ""
echo "To restore the local backup:"
echo "  wp db import $LOCAL_BACKUP"

